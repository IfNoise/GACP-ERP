# ТЕХНИЧЕСКОЕ ЗАДАНИЕ

## ERP-система для GACP-сертификации каннабис-ферм

**Версия:** 1.0  
**Дата:** 13 сентября 2025 г.  
**Статус:** ЧЕРНОВИК

---

## 1. ОБЩИЕ ПОЛОЖЕНИЯ

### 1.1 Наименование системы

ERP-система для управления каннабис-фермой с соблюдением стандартов GACP (Good Agricultural and Collection Practice)

### 1.2 Основание для разработки

- Требования стандарта WHO GACP (2003)
- Требования стандарта EMA GACP (2006)
- Требования EU GMP Annex 11 (Computerised Systems)
- Требования FDA 21 CFR Part 11 (Electronic Records and Electronic Signatures)
- Требования MHRA GxP Data Integrity (ALCOA+)
- Методология GAMP 5 (2nd Edition, 2022)

### 1.3 Цель создания системы

Создание комплексной ERP-системы, обеспечивающей:

- Полное соответствие требованиям GACP для медицинского каннабиса
- Автоматизацию всех процессов от семени до продажи (seed-to-sale)
- Immutable audit trail и электронные подписи
- Готовность к аудиту регулирующих органов
- Масштабируемость и надежность на уровне enterprise

---

## 2. АВТОМАТИЗИРУЕМЫЕ ОБЪЕКТЫ

### 2.1 Основные бизнес-процессы

- **Cultivation Management**: Жизненный цикл растений (от семени до сбора)
- **Quality Control & Laboratory**: Контроль качества и лабораторные анализы
- **Equipment & Environment**: Управление оборудованием и мониторинг среды
- **Financial Management**: Учет биологических активов, cost tracking, payroll
- **Procurement & Suppliers**: Управление закупками и квалификация поставщиков
- **Spatial & Planning**: Управление пространством и планирование производства
- **Forecasting & Analytics**: Прогнозирование урожайности и планирование циклов
- **Training & Knowledge**: Обучение персонала, аттестация, база знаний
- **Compliance & Reporting**: Соответствие нормативным требованиям и отчетность
- **Document Management**: Управление документами и версионирование
- **Integration & External Systems**: Интеграция с METRC, BioTrackTHC, accounting

### 2.2 Пользователи системы

- **Операторы фермы** - выполнение агротехнических операций
- **Супервайзеры** - контроль операций, утверждение процедур
- **QA специалисты** - контроль качества, подписание batch records
- **Менеджеры** - планирование, аналитика, отчетность
- **Аудиторы** - проверка соответствия GACP требованиям
- **Системные администраторы** - техническое обслуживание

### 2.3 Масштаб системы

- **Пользователи:** до 100 одновременных пользователей
- **Растения:** до 10,000 растений в обороте
- **Партии:** до 1,000 активных партий
- **События:** до 1 млн audit trail записей в год
- **Хранение данных:** минимум 10 лет

---

## 3. ТРЕБОВАНИЯ К СИСТЕМЕ

### 3.1 Функциональные требования

#### 3.1.1 Модуль культивации (Cultivation)

- Регистрация посевного материала (семена/клоны)
- Ведение жизненного цикла растений (посадка → вегетация → цветение → сбор)
- Планирование и учет агротехнических мероприятий
- Трекинг перемещений растений между зонами
- Управление партиями (batch management)

#### 3.1.2 Модуль контроля качества (Quality Control)

- Регистрация результатов лабораторных анализов
- Управление отклонениями (deviation management)
- Контроль спецификаций и критических параметров
- Система CAPA (Corrective and Preventive Actions)
- Управление сертификатами анализов (CoA)

#### 3.1.3 Модуль оборудования и среды (Equipment & Environment)

- Мониторинг климатических параметров (температура, влажность, CO₂)
- Интеграция с IoT сенсорами и SCADA системами
- Система аварийных уведомлений
- Календарь калибровки и обслуживания оборудования
- Журналы работы оборудования

#### 3.1.4 Модуль соответствия требованиям (Compliance)

- Автоматическое формирование GACP отчетов
- Генерация batch records с электронными подписями
- Подготовка пакетов документов для аудита
- Трассируемость от семени до продажи
- Экспорт данных в форматах для регуляторов

#### 3.1.5 Модуль обучения и знаний (Training & Knowledge)

- База знаний с SOP и инструкциями
- Система курсов и тестирования персонала
- Матрица компетенций по должностям
- Журналы обучения и аттестации
- Контроль актуальности обучения

#### 3.1.6 Модуль документооборота (Document Management)

- Версионирование документов (SOP, инструкции)
- Workflow утверждения изменений
- Электронные подписи документов
- Контроль доступа к документам
- Архивное хранение

### 3.2 Нефункциональные требования

#### 3.2.1 Требования производительности

- **Время отклика:** не более 2 секунд для стандартных операций
- **Пропускная способность:** до 1000 операций в минуту
- **Доступность:** 99.9% (не более 8.76 часов простоя в год)
- **Масштабируемость:** возможность увеличения нагрузки в 10 раз

#### 3.2.2 Требования надежности

- **RTO (Recovery Time Objective):** 4 часа
- **RPO (Recovery Point Objective):** 15 минут
- **Geo-redundancy:** 2 географически разнесенных дата-центра
- **Backup:** ежедневные полные и почасовые инкрементальные копии

#### 3.2.3 Требования безопасности

- **Аутентификация:** многофакторная (MFA) для критических ролей
- **Авторизация:** ролевая модель с принципом минимальных привилегий
- **Шифрование:** AES-256 для данных в покое, TLS 1.3 для данных в передаче
- **Audit Trail:** неизменяемое логирование всех действий пользователей

#### 3.2.4 Требования совместимости

- **Браузеры:** Chrome 90+, Firefox 88+, Safari 14+
- **Мобильные устройства:** iOS 14+, Android 10+
- **API:** RESTful с OpenAPI 3.0 документацией
- **Интеграции:** поддержка FHIR, HL7, CSV, XML, JSON форматов

---

## 4. АРХИТЕКТУРНЫЕ ТРЕБОВАНИЯ

### 4.1 Общая архитектура

**Микросервисная архитектура** с разделением по доменам:

- API Gateway (маршрутизация, аутентификация)
- Cultivation Service (жизненный цикл растений)
- Quality Service (лабораторные данные)
- Equipment Service (IoT и мониторинг)
- Compliance Service (отчетность и аудит)
- Document Service (управление документами)
- Training Service (обучение персонала)

### 4.2 Технологический стек

#### 4.2.1 Backend

- **Язык:** TypeScript/Node.js
- **Фреймворк:** NestJS
- **API:** ts-rest с Zod валидацией
- **База данных:** PostgreSQL (основная), immudb (audit trail)
- **Событийная шина:** Apache Kafka
- **Кэширование:** Redis
- **Поиск:** Elasticsearch

#### 4.2.2 Frontend

- **Фреймворк:** Next.js 14+ с App Router
- **UI библиотека:** React 18+ с TypeScript
- **Состояние:** Zustand
- **Формы:** React Hook Form с Zod
- **Стилизация:** Tailwind CSS
- **Графики:** Recharts, D3.js

#### 4.2.3 Инфраструктура

- **Контейнеризация:** Docker + Kubernetes
- **Мониторинг:** VictoriaMetrics, Loki, Tempo, Grafana
- **CI/CD:** GitHub Actions / GitLab CI
- **WORM хранилище:** MinIO с Object Lock
- **Identity Provider:** Keycloak
- **Service Mesh:** Istio (опционально)

### 4.3 Принципы проектирования

#### 4.3.1 Contract-First Development

- Все API определяются через ts-rest contracts
- Единая типизация между frontend и backend
- Автоматическая генерация документации
- Валидация на всех уровнях через Zod схемы

#### 4.3.2 Event-Driven Architecture

- Все критические действия генерируют события
- Immutable event store в Kafka
- Event sourcing для audit trail
- CQRS для разделения команд и запросов

#### 4.3.3 Risk-Based Approach

- **High Risk:** e-signatures, batch release, master data changes
- **Medium Risk:** user management, reporting, document versioning
- **Low Risk:** dashboards, analytics, notifications

---

## 5. ТРЕБОВАНИЯ К СООТВЕТСТВИЮ НОРМАТИВАМ

### 5.1 ALCOA+ Принципы

- **Attributable:** каждая запись привязана к пользователю
- **Legible:** данные читаемы и понятны
- **Contemporaneous:** данные вводятся в момент выполнения действия
- **Original:** первичные записи сохраняются
- **Accurate:** данные корректны и полны
- **Complete:** все необходимые данные присутствуют
- **Consistent:** данные не противоречивы
- **Enduring:** данные сохраняются в течение требуемого периода
- **Available:** данные доступны для проверки

### 5.2 Audit Trail

- **Неизменяемость:** записи нельзя удалить или изменить
- **Полнота:** фиксируются все критические действия
- **Временные метки:** точное время UTC для всех событий
- **Идентификация:** каждое действие привязано к пользователю
- **Причина изменений:** обязательное поле для критических операций

**Go-based Audit Consumer архитектура:**

- High-performance Kafka consumer написанный на Go
- Batch processing: 100-1000 events per batch для оптимальной производительности
- Direct integration с immudb SDK для криптографических доказательств
- Graceful shutdown с обработкой всех pending events
- Health checks и Prometheus metrics для мониторинга
- Circuit breaker pattern для fault tolerance

### 5.3 Электронные подписи (21 CFR Part 11)

- **Двухфакторная аутентификация** для критических операций
- **Step-up authentication** с auth_time ≤ 120 секунд
- **Подпись с контекстом:** включает timestamp, user ID, sign meaning
- **Неотказуемость:** невозможность отрицания факта подписания
- **Привязка к данным:** подпись связана с конкретными данными

---

## 6. ТРЕБОВАНИЯ К РАЗВЕРТЫВАНИЮ

### 6.1 Окружения

- **Development:** локальная разработка с docker-compose
- **Testing:** автоматическое тестирование в CI/CD
- **Staging:** предпродуктивная среда для UAT
- **Production:** продуктивная среда с geo-redundancy

### 6.2 Инфраструктурные требования

#### 6.2.1 Продуктивная среда

**Дата-центр 1 (Основной):**

- 4 узла Kubernetes (8 CPU, 32 GB RAM каждый)
- 3 узла PostgreSQL cluster (16 CPU, 64 GB RAM, 2 TB SSD)
- 3 узла Kafka cluster (8 CPU, 32 GB RAM, 1 TB SSD)
- 2 узла immudb cluster (4 CPU, 16 GB RAM, 500 GB SSD)
- 3 узла MinIO cluster (4 CPU, 16 GB RAM, 10 TB HDD)
- 2 узла Keycloak HA (4 CPU, 16 GB RAM)

**Дата-центр 2 (Резервный):**

- Аналогичная конфигурация с async репликацией
- Возможность полного переключения за 4 часа

#### 6.2.2 Сетевые требования

- **Скорость соединения между DC:** минимум 1 Gbps
- **Задержка между DC:** не более 100 мс
- **Внешний доступ:** HTTPS с сертификатами TLS 1.3
- **VPN:** для административного доступа

---

## 7. ПЛАН ВАЛИДАЦИИ

### 7.1 Валидационные документы

- **VMP (Validation Master Plan)** - общий план валидации
- **URS (User Requirements Specification)** - требования пользователей
- **FS (Functional Specification)** - функциональные спецификации
- **DS (Design Specification)** - техническое описание системы
- **RA (Risk Assessment)** - оценка рисков
- **Traceability Matrix** - матрица трассируемости

### 7.2 Протоколы квалификации

- **IQ (Installation Qualification)** - квалификация установки
- **OQ (Operational Qualification)** - квалификация функционирования
- **PQ (Performance Qualification)** - квалификация эксплуатационных характеристик

### 7.3 Процедуры управления изменениями

- **Change Control** - контроль изменений
- **Impact Assessment** - оценка влияния изменений
- **Regression Testing** - регрессионное тестирование
- **Release Management** - управление релизами

---

## 8. ЭТАПЫ РАЗРАБОТКИ

### 8.1 Подготовительный этап (4 недели)

- Детализация требований
- Создание архитектурной документации
- Настройка инфраструктуры разработки
- Подготовка валидационных документов

### 8.2 Разработка MVP (12 недель)

- Базовые модули (Cultivation, Quality)
- Аутентификация и авторизация
- Audit Trail и WORM хранилище
- Базовая отчетность

### 8.3 Расширение функциональности (16 недель)

- Модули Equipment, Compliance, Training
- Интеграция с внешними системами
- Расширенная отчетность
- Мобильное приложение

### 8.4 Валидация и внедрение (8 недель)

- IQ/OQ/PQ тестирование
- UAT с конечными пользователями
- Обучение персонала
- Промышленное развертывание

---

## 9. КРИТЕРИИ ПРИЕМКИ

### 9.1 Функциональные критерии

- ✅ Все модули реализованы согласно URS
- ✅ Successful прохождение IQ/OQ/PQ тестов
- ✅ Соответствие GACP требованиям (подтверждено аудитом)
- ✅ Производительность соответствует SLA
- ✅ Все отчеты генерируются корректно

### 9.2 Технические критерии

- ✅ Audit Trail функционирует без потери данных
- ✅ Электронные подписи соответствуют 21 CFR Part 11
- ✅ Geo-redundancy обеспечивает RTO/RPO
- ✅ Безопасность прошла penetration testing
- ✅ Документация полная и актуальная

### 9.3 Бизнес критерии

- ✅ Система готова к регуляторному аудиту
- ✅ Персонал обучен работе с системой
- ✅ Все SOP адаптированы под новую систему
- ✅ Миграция данных завершена успешно
- ✅ Техническая поддержка настроена

---

## 10. РИСКИ И МИТИГАЦИЯ

### 10.1 Технические риски

| Риск                    | Вероятность | Влияние | Митигация                  |
| ----------------------- | ----------- | ------- | -------------------------- |
| Сложность валидации     | Высокая     | Высокое | Привлечение CSV экспертов  |
| Производительность WORM | Средняя     | Среднее | Тестирование под нагрузкой |
| Интеграция с IoT        | Средняя     | Среднее | Прототипирование           |

### 10.2 Регуляторные риски

| Риск                   | Вероятность | Влияние     | Митигация                            |
| ---------------------- | ----------- | ----------- | ------------------------------------ |
| Несоответствие GACP    | Низкая      | Критическое | Регулярные консультации с экспертами |
| Изменения в нормативах | Средняя     | Высокое     | Модульная архитектура                |

### 10.3 Проектные риски

| Риск                  | Вероятность | Влияние | Митигация                      |
| --------------------- | ----------- | ------- | ------------------------------ |
| Превышение сроков     | Средняя     | Высокое | Agile методология, MVP подход  |
| Недостаток экспертизы | Низкая      | Высокое | Обучение команды, консультанты |

---

## ПРИЛОЖЕНИЯ

### Приложение А: Глоссарий терминов

### Приложение Б: Список нормативных документов

### Приложение В: Архитектурные диаграммы

### Приложение Г: Матрица требований

### Приложение Д: План тестирования

---

**Дата создания:** 13 сентября 2025 г.  
**Версия:** 1.0  
**Статус:** ЧЕРНОВИК  
**Следующий пересмотр:** через 2 недели
